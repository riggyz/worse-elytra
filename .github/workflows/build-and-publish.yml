name: Build and Publish

on:
  push:
    tags:
      - v*.*.*
  # release:
  #   types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: write
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Build with Gradle
        run: ./gradlew build

      - name: Upload Artifacts (Forge)
        uses: actions/upload-artifact@v4
        with:
          name: forge-artifacts
          path: |
            forge/build/libs/

      - name: Upload Artifacts (Fabric)
        uses: actions/upload-artifact@v4
        with:
          name: fabric-artifacts
          path: |
            fabric/build/libs/

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"  # or specify your version variable
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"

          # Extract the changelog section for this version
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit;
              if ($0 ~ "\\[" ver "\\]") {
                found=1;
                print;
                next;
              }
            }
            /^## \[/ && found {
              exit;
            }
            found {
              print;
            }
          ' CHANGELOG.md)

          # Save to output
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  publish-forge:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Artifacts (Forge)
        uses: actions/download-artifact@v4
        with:
          name: forge-artifacts
          path: ./forge/build/libs

      - name: Publish to Curseforge  and Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          files: |
            forge/build/libs/!(*-@(dev|sources|javadoc)).jar
          changelog: ${{ needs.build.outputs.changelog }}
          name: ${{ github.ref_name }}-forge
          curseforge-id: ${{ secrets.CURSEFORGE_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          modrinth-id: ${{ secrets.MODRINTH_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

  publish-fabric:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Artifacts (Fabric)
        uses: actions/download-artifact@v4
        with:
          name: fabric-artifacts
          path: ./fabric/build/libs

      - name: Publish to Curseforge and Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          files: |
            fabric/build/libs/!(*-@(dev|sources|javadoc)).jar
          changelog: ${{ needs.build.outputs.changelog }}
          name: ${{ github.ref_name }}-fabric
          curseforge-id: ${{ secrets.CURSEFORGE_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          modrinth-id: ${{ secrets.MODRINTH_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

  generate-release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Download Artifacts (Forge)
        uses: actions/download-artifact@v4
        with:
          name: forge-artifacts
          path: ./forge/build/libs
      - name: Download Artifacts (Fabric)
        uses: actions/download-artifact@v4
        with:
          name: fabric-artifacts
          path: ./fabric/build/libs

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ needs.build.outputs.changelog }}
          files: |
            **/build/libs/!(*-@(dev|sources|javadoc)).jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
